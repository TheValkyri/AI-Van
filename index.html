<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trợ lý Viết văn AI (Bản nâng cấp 2025)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Lexend', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
        }
        .gemini-section {
            background: #111827; /* gray-900 */
            background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.1) 1px, transparent 0);
            background-size: 1.5rem 1.5rem;
        }
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: #4f46e5; /* indigo-600 */
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .result-card h3 {
            border-left: 4px solid #4f46e5; /* indigo-600 */
            padding-left: 1rem;
        }
        details > summary {
            list-style: none;
            cursor: pointer;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        .details-marker {
            transition: transform 0.3s ease-in-out;
        }
        details[open] .details-marker {
            transform: rotate(135deg);
        }
        .details-content {
            border-top: 1px solid #e5e7eb;
            padding: 1.5rem;
            background-color: #fafafa;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-12">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-800">Cấu Trúc Bài Văn Nghị Luận Xã Hội</h1>
            <p class="mt-3 text-gray-600 text-lg">Theo định hướng phát triển năng lực mới nhất</p>
        </header>

        <!-- Interactive Main Content -->
        <div class="grid md:grid-cols-1 gap-8 mb-16">
            <details class="bg-white rounded-xl shadow-md overflow-hidden transition-all duration-300">
                <summary class="flex justify-between items-center p-6 border-t-4 border-blue-500">
                    <div class="text-left"><h2 class="text-xl font-bold text-gray-800">MỞ BÀI</h2><p class="text-gray-500">Dẫn dắt & Nêu vấn đề</p></div>
                    <div class="details-marker text-blue-500 text-3xl font-light">+</div>
                </summary>
                <div class="details-content text-left text-gray-700 space-y-3">
                    <p><strong>Mục tiêu:</strong> Tạo sự hấp dẫn, giới thiệu chính xác vấn đề nghị luận trong khoảng 3-5 câu.</p>
                    <ul class="list-disc list-inside space-y-2">
                        <li><strong>Cách 1: Mở bài trực tiếp:</strong> Giới thiệu thẳng vào vấn đề cần nghị luận. Thích hợp khi cần sự rõ ràng, mạch lạc.</li>
                        <li><strong>Cách 2: Mở bài gián tiếp:</strong> Dẫn dắt từ một câu chuyện, một câu danh ngôn, một thực tế đời sống để đi đến vấn đề. Cách này giúp bài viết sinh động, lôi cuốn hơn.</li>
                        <li><strong>Cấu trúc mẫu:</strong> Câu 1 (Dẫn dắt) -> Câu 2 (Nêu vấn đề từ đề bài) -> Câu 3 (Chuyển ý, khẳng định ngắn gọn).</li>
                    </ul>
                </div>
            </details>
            <details class="bg-white rounded-xl shadow-md overflow-hidden transition-all duration-300">
                <summary class="flex justify-between items-center p-6 border-t-4 border-orange-500">
                    <div class="text-left"><h2 class="text-xl font-bold text-gray-800">THÂN BÀI</h2><p class="text-gray-500">Giải thích, Phân tích, Phản biện</p></div>
                     <div class="details-marker text-orange-500 text-3xl font-light">+</div>
                </summary>
                <div class="details-content text-left text-gray-700 space-y-4">
                     <p><strong>Mục tiêu:</strong> Triển khai các luận điểm một cách logic, thuyết phục, có dẫn chứng và chiều sâu.</p>
                     <div class="space-y-3 pl-4 border-l-2 border-orange-200">
                        <p><strong>▶️ Bước 1: Giải thích:</strong> Làm rõ các khái niệm, từ khóa, và ý nghĩa của toàn bộ vấn đề. Trả lời câu hỏi: "Vấn đề này là gì?".</p>
                        <p><strong>▶️ Bước 2: Phân tích & Bàn luận:</strong> Đây là phần trọng tâm. Cần nêu rõ biểu hiện trong đời sống, phân tích nguyên nhân (chủ quan, khách quan), và chỉ ra ý nghĩa/tác hại của vấn đề. Cần có ít nhất 2 dẫn chứng tiêu biểu, xác thực.</p>
                        <p><strong>▶️ Bước 3: Phản biện & Mở rộng:</strong> Lật lại vấn đề, phê phán các biểu hiện sai lệch, nhìn từ nhiều góc độ để bài viết có chiều sâu, tránh phiến diện.</p>
                        <p><strong>▶️ Bước 4: Bài học nhận thức & Hành động:</strong> Rút ra bài học cho bản thân và đề xuất các giải pháp cụ thể, khả thi. Trả lời câu hỏi: "Chúng ta cần làm gì?".</p>
                     </div>
                </div>
            </details>
            <details class="bg-white rounded-xl shadow-md overflow-hidden transition-all duration-300">
                <summary class="flex justify-between items-center p-6 border-t-4 border-green-500">
                    <div class="text-left"><h2 class="text-xl font-bold text-gray-800">KẾT BÀI</h2><p class="text-gray-500">Khẳng định & Thông điệp</p></div>
                    <div class="details-marker text-green-500 text-3xl font-light">+</div>
                </summary>
                <div class="details-content text-left text-gray-700 space-y-3">
                    <p><strong>Mục tiêu:</strong> Tóm lược lại vấn đề, tạo dư âm và lan tỏa thông điệp ý nghĩa trong khoảng 2-4 câu.</p>
                     <ul class="list-disc list-inside space-y-2">
                        <li><strong>Bước 1: Khẳng định lại vấn đề:</strong> Dùng một câu ngắn gọn để tóm lược và nhấn mạnh lại tầm quan trọng của vấn đề đã bàn luận.</li>
                        <li><strong>Bước 2: Liên hệ & Gửi thông điệp:</strong> Nêu hành động của bản thân và gửi gắm một lời kêu gọi, một thông điệp tích cực đến mọi người để kết thúc bài viết một cách trọn vẹn.</li>
                    </ul>
                </div>
            </details>
        </div>

        <!-- Gemini AI Assistant Section -->
        <section id="gemini-assistant" class="p-8 md:p-12 rounded-2xl gemini-section text-white shadow-2xl">
            <div class="text-center">
                <h2 class="text-4xl sm:text-5xl font-extrabold tracking-tight">Trợ lý Viết văn AI 2025</h2>
                <p class="mt-4 text-lg text-gray-300 max-w-3xl mx-auto">Nhận ngay dàn ý chi tiết và những dẫn chứng đắt giá, cập nhật đến năm 2025 chỉ trong vài giây!</p>
            </div>
            <div class="mt-10 max-w-3xl mx-auto">
                <div class="space-y-4">
                    <div>
                         <label for="api-key-input" class="block text-sm font-semibold text-gray-300 mb-2">Google AI API Key:</label>
                         <input type="password" id="api-key-input" placeholder="Dán API Key của bạn vào đây để kích hoạt" class="w-full px-5 py-3 rounded-lg text-gray-900 bg-gray-200 focus:outline-none focus:ring-4 focus:ring-indigo-500 transition-all placeholder:text-gray-500">
                    </div>
                     <div>
                         <label for="topic-input" class="block text-sm font-semibold text-gray-300 mb-2">Nhập chủ đề nghị luận:</label>
                         <input type="text" id="topic-input" placeholder="Ví dụ: Lòng dũng cảm, Sức mạnh của sự tử tế,..." class="w-full px-5 py-3 rounded-lg text-gray-900 bg-gray-200 focus:outline-none focus:ring-4 focus:ring-indigo-500 transition-all placeholder:text-gray-500">
                    </div>
                </div>
                <div class="mt-6">
                    <button id="generate-button" class="w-full bg-indigo-600 font-bold px-8 py-4 rounded-lg hover:bg-indigo-500 transition-colors duration-300 flex items-center justify-center gap-3 text-lg transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        Tạo Dàn Ý Siêu Tốc
                    </button>
                </div>
            </div>
            
            <div id="result-container" class="mt-12"></div>
        </section>

        <!-- Footer -->
        <footer class="text-center mt-12"><p class="text-gray-500">Một sản phẩm được nâng cấp bởi AI. Chúc bạn thi tốt!</p></footer>
    </div>

<script>
    const generateButton = document.getElementById('generate-button');
    const topicInput = document.getElementById('topic-input');
    const apiKeyInput = document.getElementById('api-key-input');
    const resultContainer = document.getElementById('result-container');

    generateButton.addEventListener('click', handleGeneration);
    [topicInput, apiKeyInput].forEach(input => {
        input.addEventListener('keyup', (event) => { if (event.key === 'Enter') handleGeneration(); });
    });

    // NEW: Function to attempt API call with retries
    async function fetchWithRetry(apiUrl, payload, retries = 2) {
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    // Don't retry on client-side errors like 4xx
                    if (response.status >= 400 && response.status < 500) {
                        throw new Error(`API Error: ${response.statusText} (status: ${response.status})`);
                    }
                    // For server-side errors 5xx, retry
                    if (i === retries - 1) throw new Error(`API Error: ${response.statusText} (status: ${response.status})`);
                    continue; // Go to the next retry
                }

                const result = await response.json();
                
                let resultText = '';
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content?.parts?.length > 0) {
                     resultText = result.candidates[0].content.parts[0].text;
                } else {
                     throw new Error("AI không thể tạo dàn ý cho chủ đề này. Vui lòng thử lại với một chủ đề khác.");
                }

                // Try to parse the JSON, this is where "Unterminated string" happens
                const parsedResult = JSON.parse(resultText);
                return parsedResult; // Success! Exit the loop and return the result.

            } catch (error) {
                console.warn(`Attempt ${i + 1} failed:`, error.message);
                if (i === retries - 1) {
                    // If this was the last retry, re-throw the error to be caught by the main handler
                    throw error;
                }
                // Optional: wait a bit before retrying
                await new Promise(res => setTimeout(res, 500));
            }
        }
    }


    async function handleGeneration() {
        const topic = topicInput.value.trim();
        const apiKey = apiKeyInput.value.trim();

        if (!apiKey) {
            displayError("Vui lòng nhập API Key của bạn để sử dụng tính năng này.");
            return;
        }
        if (!topic) {
            displayError("Vui lòng nhập một chủ đề để bắt đầu.");
            return;
        }

        resultContainer.innerHTML = `<div class="loader"></div> <p class="text-center text-gray-300">AI đang phân tích và thử tạo dàn ý, vui lòng chờ...</p>`;

        try {
            const prompt = `Bạn là một chuyên gia phân tích xã hội và giáo viên văn xuất sắc. Hãy tạo một dàn ý chi tiết cho bài văn nghị luận xã hội với chủ đề: "${topic}". 
            - Phần Dàn Ý cần đầy đủ 3 phần Mở-Thân-Kết.
            - Phần Dẫn Chứng: Hãy tìm 2-3 ví dụ tiêu biểu, đa dạng (từ đời sống, lịch sử, các sự kiện xã hội) và cập nhật các sự kiện đến năm 2024-2025 để làm minh họa. Mỗi dẫn chứng cần được phân tích thành các gạch đầu dòng rõ ràng.
            Hãy trả về kết quả dưới dạng JSON theo cấu trúc sau, không thêm bất kỳ văn bản nào khác.`;

            const schema = {
              type: "OBJECT",
              properties: {
                "dan_y": { type: "OBJECT", properties: { "mo_bai": { type: "STRING" }, "than_bai": { type: "OBJECT", properties: { "giai_thich": { type: "STRING" }, "phan_tich_ban_luan": { type: "STRING" }, "phan_bien_mo_rong": { type: "STRING" }, "bai_hoc_hanh_dong": { type: "STRING" } } }, "ket_bai": { type: "STRING" } } },
                "dan_chung": { type: "ARRAY", items: { type: "OBJECT", properties: { "tieu_de": { type: "STRING" }, "y_chinh": { type: "ARRAY", items: {type: "STRING"}} } } }
              }
            };
            
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema } };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            // Use the new fetchWithRetry function
            const finalResult = await fetchWithRetry(apiUrl, payload);
            
            displayResult(finalResult, topic);

        } catch (error) {
            console.error('Final error after retries:', error);
            displayError(`Đã có lỗi xảy ra sau vài lần thử. Vui lòng kiểm tra lại API Key và thử lại. (${error.message})`);
        }
    }

    function displayError(message) {
         resultContainer.innerHTML = `<div class="bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded-lg" role="alert">
            <strong class="font-bold">Rất tiếc!</strong>
            <span class="block sm:inline">${message}</span>
        </div>`;
    }

    function displayResult(data, topic) {
        const dan_y = data.dan_y || {};
        const than_bai = dan_y.than_bai || {};
        const dan_chung = data.dan_chung || [];

        const danChungHtml = dan_chung.map(dc => `
            <div class="bg-gray-800 p-6 rounded-lg">
                <h4 class="font-bold text-lg text-indigo-400">${dc.tieu_de || 'Không có tiêu đề'}</h4>
                <ul class="mt-3 space-y-2">
                    ${(dc.y_chinh || []).map(yc => `
                        <li class="flex items-start">
                            <svg class="w-5 h-5 mr-3 text-green-400 flex-shrink-0 mt-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                            <span class="text-gray-300">${yc}</span>
                        </li>
                    `).join('')}
                </ul>
            </div>
        `).join('<div class="my-6 border-t border-gray-700"></div>');

        const danChungSection = dan_chung.length > 0 ? `
            <div class="result-card bg-gray-900/50 p-6 md:p-8 rounded-xl backdrop-blur-sm border border-gray-700">
                <h3 class="text-2xl font-bold mb-6 text-white">Dẫn Chứng Tiêu Biểu (Cập nhật 2025)</h3>
                ${danChungHtml}
            </div>
        ` : '';

        const resultHtml = `
            <div class="space-y-8">
                <div class="result-card bg-gray-900/50 p-6 md:p-8 rounded-xl backdrop-blur-sm border border-gray-700">
                    <h3 class="text-2xl font-bold mb-6 text-white">Dàn Ý Chi Tiết cho: "${topic}"</h3>
                    <div class="space-y-4 text-gray-300">
                        <p><strong>Mở bài:</strong> ${dan_y.mo_bai || 'Chưa có gợi ý.'}</p>
                        <div>
                            <p><strong>Thân bài:</strong></p>
                            <ul class="list-disc list-inside ml-4 mt-2 space-y-2">
                                <li><strong>Giải thích:</strong> ${than_bai.giai_thich || 'Chưa có gợi ý.'}</li>
                                <li><strong>Phân tích, bàn luận:</strong> ${than_bai.phan_tich_ban_luan || 'Chưa có gợi ý.'}</li>
                                <li><strong>Phản biện, mở rộng:</strong> ${than_bai.phan_bien_mo_rong || 'Chưa có gợi ý.'}</li>
                                <li><strong>Bài học và hành động:</strong> ${than_bai.bai_hoc_hanh_dong || 'Chưa có gợi ý.'}</li>
                            </ul>
                        </div>
                        <p><strong>Kết bài:</strong> ${dan_y.ket_bai || 'Chưa có gợi ý.'}</p>
                    </div>
                </div>
                ${danChungSection}
            </div>
        `;
        resultContainer.innerHTML = resultHtml;
    }
</script>
</body>
</html>
